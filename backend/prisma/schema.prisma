generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  elements    Element[]
  references  Reference[]
  styleGuides StyleGuide[]
  generations Generation[]
  scenes      Scene[]
  sessions    Session[]
  loras       LoRA[]
  modelParameters ModelParameter[]
  workflows   Workflow[]
  trainingJobs TrainingJob[]
  customPosePresets CustomPosePreset[]
}

model Session {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id])
  generations Generation[]
  scenes      Scene[]
  elements    Element[]
}

model Element {
  id        String   @id @default(uuid())
  projectId String
  name      String   // Unique per project logic handled in app or composite unique constraint
  type      String   // 'character', 'prop', 'product', 'location', 'other'
  fileUrl   String
  isFavorite Boolean @default(false)
  tags      String   @default("[]") // JSON array string for SQLite
  metadata  String?  // JSON string for SQLite
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
  session Session? @relation(fields: [sessionId], references: [id])
  sessionId String?

  @@unique([projectId, name])
}

model Reference {
  id        String   @id @default(uuid())
  projectId String
  name      String
  fileUrl   String
  metadata  String?  // JSON string for SQLite
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
}

model StyleGuide {
  id              String   @id @default(uuid())
  projectId       String
  name            String
  description     String?
  files           String?  // JSON string for SQLite - List of file URLs
  derivedMetadata String?  // JSON string for SQLite - Color palettes, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  project     Project      @relation(fields: [projectId], references: [id])
  generations Generation[]
}

model Generation {
  id                 String   @id @default(uuid())
  projectId          String
  mode               String   // 'text_to_image', etc.
  inputPrompt        String
  resolvedPrompt     String?
  shotType           String?
  cameraAngle        String?
  location           String?
  lighting           String?
  outputResolution   String?
  aspectRatio        String?
  variations         Int      @default(1)
  styleGuideId       String?
  sourceElementIds   String?  // JSON string for SQLite
  sourceReferenceIds String?  // JSON string for SQLite

  name               String?
  tags               String   @default("[]") // JSON array string for SQLite
  engine             String   @default("fal") // 'fal', 'comfy'
  usedLoras          String?  // JSON string for SQLite - List of { id, strength, path }

  prevGenerationId   String?
  sessionId          String?
  isFavorite         Boolean  @default(false)
  status             String   @default("queued") // 'queued', 'running', 'succeeded', 'failed'
  failureReason      String?
  outputs            String?  // JSON string for SQLite - List of { type, url, thumbnail_url }
  provider           String?
  actualCost         Float?
  inferenceTime      Int?     // milliseconds
  rating             Int?     // 1-5 stars
  aiAnalysis         String?  // JSON string from Grok
  feedbackNotes      String?  // User manual notes
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  project        Project      @relation(fields: [projectId], references: [id])
  session        Session?     @relation(fields: [sessionId], references: [id])
  styleGuide     StyleGuide?  @relation(fields: [styleGuideId], references: [id])
  prevGeneration Generation?  @relation("ChainedGenerations", fields: [prevGenerationId], references: [id])
  nextGenerations Generation[] @relation("ChainedGenerations")
  sceneShots     SceneShot[]
}

model Scene {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  referenceElementIds String?  // JSON string for SQLite - Element IDs to use as IP-Adapter references
  inheritReferences   Boolean  @default(true)
  defaultReferenceStrength Float @default(0.7)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sessionId   String?
  project Project     @relation(fields: [projectId], references: [id])
  session Session?    @relation(fields: [sessionId], references: [id])
  shots   SceneShot[]
}

model SceneShot {
  id           String   @id @default(uuid())
  sceneId      String
  generationId String
  index        Int
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  scene      Scene      @relation(fields: [sceneId], references: [id])
  generation Generation @relation(fields: [generationId], references: [id])
}

model LoRA {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  triggerWord String?
  triggerWords String? // JSON array for multiple trigger words
  aliasPatterns String? // JSON array of custom aliases (e.g., ["sarah", "sara"]) for prompt detection
  fileUrl     String   // Local path or HF URL
  baseModel   String   // 'SDXL', 'Flux', 'SVD', 'Other'
  strength    Float    @default(1.0)
  strengthMin Float    @default(0.5)
  strengthMax Float    @default(1.2)
  imageUrl    String?  // Thumbnail
  type        String   @default("other") // 'checkpoint', 'lora', 'embedding'
  category    String?  // 'character', 'style', 'concept', 'clothing', 'pose', 'background', 'effect', 'other'
  characterAttributes String? // JSON for character-specific attributes
  recommendedSettings String? // JSON string for SQLite compatibility
  globalLoRAId String? // Reference to global library item
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id])
  globalLoRA  GlobalLoRA? @relation(fields: [globalLoRAId], references: [id])
}

// Global LoRA Library - shared across all projects
model GlobalLoRA {
  id          String   @id @default(uuid())
  name        String
  triggerWord String?
  aliasPatterns String? // JSON array of custom aliases (e.g., ["sarah", "sara"]) for prompt detection
  fileUrl     String   // Local path or HF URL
  baseModel   String   // 'SDXL', 'Flux', 'SD1.5', 'Other'
  strength    Float    @default(1.0)
  imageUrl    String?  // Thumbnail
  type        String   @default("lora") // 'checkpoint', 'lora', 'embedding'
  category    String?  // 'character', 'style', 'concept', 'clothing', 'pose', 'background', 'effect', 'other'
  recommendedSettings String? // JSON string for SQLite compatibility
  civitaiModelId String? // For linking back to Civitai
  civitaiVersionId String?
  description String?
  tags        String   @default("[]") // JSON array string for SQLite
  usageCount  Int      @default(0) // Track popularity
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Project installations
  projectInstalls LoRA[]
}

model ModelParameter {
  id        String   @id @default(uuid())
  projectId String
  type      String   // 'sampler', 'scheduler'
  name      String   // Display name e.g. "DPM++ 2M Karras"
  value     String   // API value e.g. "dpmpp_2m_karras"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project  @relation(fields: [projectId], references: [id])
}

model Workflow {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  description String?
  fileUrl     String
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project  @relation(fields: [projectId], references: [id])
}

model TrainingJob {
  id            String   @id @default(uuid())
  projectId     String
  name          String
  triggerWord   String
  datasetUrl    String?
  providerJobId String?
  status        String   @default("uploading") // 'uploading', 'queued', 'training', 'completed', 'failed'
  loraUrl       String?
  error         String?
  steps         Int      @default(1000)
  learningRate  Float    @default(0.0001)
  isStyle       Boolean  @default(true)
  provider      String   @default("fal") // 'fal', 'replicate'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project       Project  @relation(fields: [projectId], references: [id])
}

// Custom Pose Presets for Character Foundry
model CustomPosePreset {
  id          String   @id @default(uuid())
  projectId   String?  // null = global preset available to all projects
  name        String
  description String?
  stylePrefix String?  // Prepended to all prompts for style consistency
  poses       String   // JSON array of pose prompt strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project? @relation(fields: [projectId], references: [id])
}
